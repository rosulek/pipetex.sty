%% This program is free software; you can redistribute it and/or
%% modify it under the terms of the GNU General Public License
%% as published by the Free Software Foundation; either version 2
%% of the License, or (at your option) any later version.
%%
%% This program is distributed in the hope that it will be useful,
%% but WITHOUT ANY WARRANTY; without even the implied warranty of
%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%% GNU General Public License for more details.
%%
%% You should have received a copy of the GNU General Public License
%% along with this program; if not, write to the Free Software
%% Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
%%
%% Author: Mike Rosulek
%% Adapted from python.sty by Martin R. Ehmsen
%%
%% You can find an online copy of the GPL at
%% http://www.gnu.org/copyleft/gpl.html .

\NeedsTeXFormat{LaTeX2e}[1994/12/01]
\ProvidesPackage{pipeto}[2022/03/04 pipe to command]

\def\@pipetocmd{echo hello world}
\gdef\setpipetocmd#1{\def\@pipetocmd{#1}}

\def\@pipetodir{.}
\gdef\setpipetodir#1{\def\@pipetodir{#1}}

\newwrite\@out
\newwrite\@module

\begingroup \catcode `|=0 \catcode `[=1
\catcode`]=2 \catcode `\{=12 \catcode `\}=12
\catcode`\\=12 |gdef|@xpipeto#1\end{pipeto}[|immediate|write|@out[#1]|end[pipeto]]
|endgroup

\def\pipeto{\kernel@ifnextchar [{\@pipeto}{\@pipeto[]}}

\def\@pipeto[#1]{%
\gdef\@pipetoinclude{#1}%
\immediate\openout\@out=\jobname.pipeto
\newlinechar='15
\begingroup \catcode`\^^M=12 %
\let\do\@makeother\dospecials\obeyspaces%
\@xpipeto}

\def\endpipeto{%
\endgroup
\immediate\closeout\@out
\@writemodule
\immediate\write18{\@pipetocmd < \@pipetodir/\jobname.pipeto  > \@pipetodir/\jobname.pipeto.out 2> \@pipetodir/\jobname.pipeto.err}%
\immediate\input \@pipetodir/\jobname.pipeto.out}
%\immediate\write{\begin{verbatim}}
%\immediate\input\jobname.py.err
%\immediate\write{\end{verbatim}}}

\def\@writemodule{%
\immediate\openout\@module=latex.pipeto
\immediate\write\@module{jobname="\jobname"}
\immediate\closeout\@module}
